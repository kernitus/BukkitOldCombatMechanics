name: Build and Release

on:
  release:
    types: [published]

jobs:
  build:
    # This permission is still required by the new action
    permissions:
      contents: write

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'adopt'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: wrapper

    # Build Step - No changes needed here
    - name: Run Gradle Build
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          VERSION=${{ github.event.release.tag_name }}
          VERSION=${VERSION#v}  # Strip 'v' if present
          ./gradlew clean build -Pversion=$VERSION
        else
          ./gradlew clean build
        fi
        
    - name: Upload Artifact to GitHub Release
      if: ${{ github.event_name == 'release' }}
      uses: softprops/action-gh-release@v2
      with:
        # The 'files' input takes a path to the asset(s) you want to upload.
        # Keep a stable filename for external download links.
        files: ./build/libs/OldCombatMechanics.jar

    - name: Read game versions from gradle.properties
      run: |
        RAW=$(grep ^gameVersions gradle.properties | cut -d'=' -f2-)
        # Convert "1.21, 1.20.6" -> "Minecraft 1.21:1.21,Minecraft 1.20.6:1.20.6" to disambiguate Bukkit versions
        GAME_VERSIONS=$(echo "$RAW" | tr -d ' ' | awk -F',' '{
          out="";
          for (i=1; i<=NF; i++) {
            v=$i;
            if (v!= "") {
              if (out!= "") out=out ",";
              out=out "Minecraft " v ":" v;
            }
          }
          print out;
        }')
        echo "GAME_VERSIONS=$GAME_VERSIONS" >> "$GITHUB_ENV"
        
    - name: Upload to CurseForge (Bukkit)
      if: ${{ github.event_name == 'release' }}
      uses: itsmeow/curseforge-upload@v3
      with:
        token: ${{ secrets.DBO_UPLOAD_API_TOKEN }}
        project_id: '98233'
        game_endpoint: 'bukkit'
        file_path: './build/libs/OldCombatMechanics.jar'
        changelog: ${{ github.event.release.body }}
        changelog_type: 'markdown'
        release_type: 'release'
        display_name: 'OldCombatMechanics ${{ github.event.release.tag_name }}'
        game_versions: ${{ env.GAME_VERSIONS }}


    - name: Publish to Hangar
      env:
        HANGAR_API_TOKEN: ${{ secrets.HANGAR_API_TOKEN }}
        HANGAR_CHANGELOG: ${{ github.event.release.body }}
      run: ./gradlew build publishPluginPublicationToHangar --stacktrace
